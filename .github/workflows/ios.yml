name: iOS Build

on:
  push:
    branches: ['main']
  workflow_dispatch:
  workflow_call:

env:
  HAXE_VERSION: 4.3.7
  PROJECT_NAME: Gorefield-V2

jobs:
  build:
    name: Build iOS
    runs-on: macos-15
    permissions: write-all

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Haxe
        uses: krdlab/setup-haxe@v2
        with:
          haxe-version: ${{ env.HAXE_VERSION }}

      - name: Setup haxelib directory
        run: |
          mkdir -p "$HOME/haxelib"
          haxelib setup "$HOME/haxelib"

      # Single cache step (restore + auto-save at job end)
      - name: Cache Haxe and build files
        uses: actions/cache@v4
        with:
          key: ios-haxe-${{ runner.os }}-${{ env.HAXE_VERSION }}
          path: |
            $HOME/haxelib
            export/release/ios/${{ env.PROJECT_NAME }}/haxe

      - name: Install project libraries
        run: |
          haxe -cp commandline -D analyzer-optimize --run Main setup -s

      - name: Build iOS (no signing)
        run: |
          haxelib run lime build ios -eval -nosign -final

      - name: Create IPA (robust)
        run: |
          BUILD_DIR="export/release/ios/build/Release-iphoneos"
          echo "Looking for .app in $BUILD_DIR"

          if [ ! -d "$BUILD_DIR" ]; then
            echo "ERROR: build directory does not exist"
            ls -la export/release/ios/build || true
            exit 1
          fi

          APP_BUNDLE=$(find "$BUILD_DIR" -maxdepth 1 -type d -name "*.app" -print -quit)
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: no .app found"
            ls -la "$BUILD_DIR"
            exit 1
          fi

          APP_NAME=$(basename "$APP_BUNDLE" .app)
          echo "App name: $APP_NAME"

          ENT1="export/release/ios/${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.entitlements"
          ENT2="export/release/ios/${{ env.PROJECT_NAME }}.entitlements"
          ENT=""

          if [ -f "$ENT1" ]; then
            ENT="$ENT1"
          elif [ -f "$ENT2" ]; then
            ENT="$ENT2"
          fi

          brew install ldid

          if [ -n "$ENT" ]; then
            ldid -S"$ENT" "$APP_BUNDLE/$APP_NAME"
          else
            ldid "$APP_BUNDLE/$APP_NAME" || true
          fi

          cd "$BUILD_DIR"
          mkdir -p Payload
          mv "$APP_NAME.app" Payload/
          zip -r "$APP_NAME.ipa" Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-iOS
          path: export/release/ios/build/Release-iphoneos/*.ipa
